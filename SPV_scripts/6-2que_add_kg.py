#!/usr/bin/env python
# -*- encoding: utf-8 -*-

import argparse
import os
import csv
import numpy as np
from itertools import combinations
import copy
import openai
import random
openai.api_key = "your_openai_key"




class Data_Processor:
    def __init__(self, args):
        self.data_root_path = os.path.join(args.data_dir, args.dataset)
        self.output_root_path = os.path.join(args.output_path, args.baseline, args._model, args.dataset)
    
    def get_dataset(self, file):
        file_dir = os.path.join(self.data_root_path, file)
        examples = []
        with open(file_dir, 'r', encoding='utf-8') as f:
            lines = csv.reader(f)
            next(lines)  # skip the headline
            for i, line in enumerate(lines):
                # sentence,label,target_position,target_word,pos_tag,gloss,eg_sent
                # example sentence may be empty, caution for processing
                examples.append(line)
        return examples

    def write_dataset(self, file, head, examples):
        if not os.path.exists(self.output_root_path):
            os.makedirs(self.output_root_path)
        with open(os.path.join(self.output_root_path, file), 'w', encoding='utf-8', newline='') as f:
            writer = csv.writer(f)
            writer.writerow(head)
            for line in examples:
                writer.writerow(line)

    def get_dataset_output(self, file):
        if not os.path.exists(os.path.join(self.output_root_path, file)):
            return []
        else:
            with open(os.path.join(self.output_root_path, file), 'r', encoding='utf-8') as f:
                lines = csv.reader(f)
                next(lines)  # skip the headline
                examples = []
                for i, line in enumerate(lines):
                    # sentence,label,target_position,target_word,pos_tag,gloss,eg_sent
                    # example sentence may be empty, caution for processing
                    examples.append(line)
            return examples

def return_relation_exist(answer):

    if 'Yes,' in answer or 'Yes' == answer or 'Yes.' in answer or 'is different from' in answer or 'are different' in answer or 'is indeed different from' in answer or 'is likely different from' in answer or 'be different from' in answer or 'are not significantly different' in answer or 'are indeed different' in answer or 'Therefore, in this context, the source domain is the extreme heat, and the target domain is the countryside being scorched.' in answer or 'are distinct' in answer or 'are likely different' in answer or 'appear to be different' in answer or 'is not inherently different from' in answer or ', while the target domain refers to' in answer or 'differs from' in answer or ", while the target domain represents the conceptual domain associated with personal change or profound transformation." in answer or 'is distinct from' in answer or 'can be considered different' in answer or 'which may differ from' in answer or 'appears to differ from' in answer or 'may indeed be different' in answer or 'do not align' in answer or 'is most likely different from' in answer or 'the source domain and the target domain differ in this context' in answer or 'is conceptually different from' in answer or 'is indeed different' in answer or 'can be different' in answer or 'do differ' in answer or 'there is a distinct' in answer or 'can indeed be different' in answer or 'seem to be different' in answer or 'is somewhat different from' in answer or 'might be different' in answer or 'is separate from' in answer or 'is slightly different from' in answer or 'in a different context' in answer or 'in a slightly different context' in answer or 'does differ from' in answer or 'does not match' in answer or 'uses the word "stampede" metaphorically' in answer or 'rather than its frequent literal usage' in answer or 'deviates from the frequent usage' in answer or 'does have a different context' in answer or 'is used differently in this context' in answer or 'suggests a metaphorical' in answer or 'does not align with the frequent usage' in answer or 'is used differently from' in answer or 'likely has a different context' in answer or 'is being used in a different way ' in answer or 'suggests a different usage' in answer or 'is a less common usage' in answer or 'can be interpreted as a metaphorical' in answer or 'appears to have a different usage' in answer or ' could potentially have a different context' in answer or 'differs slightly from its frequent usage' in answer or 'is used in a different sense' in answer or 'does suggest a different context' in answer or 'does seem to differ in context' in answer or 'is used in a different sense' in answer or 'seems to deviate from' in answer or 'would be considered a different context' in answer or 'appears different from its frequent usage examples' in answer or 'rather than literal' in answer or 'different from its frequent usage' in answer or 'rather than its frequent usage' in answer or 'does indicate a different context' in answer or 'differs somewhat from its frequent usage' in answer or 'seems different' in answer or 'is not the same as its frequent usage' in answer or 'does not align with its frequent usage' in answer or 'is not the same as its frequent usage' in answer or 'does not fit with the frequent usage' in answer or 'it deviates from the literal usage' in answer or 'does not have the same context' in answer or 'has a different meaning' in answer or 'may not be the same context' in answer or 'does not have the same context' in answer or 'is not being used in the same context' in answer or 'is not consistent with' in answer or 'appears to be different than its frequent usage' in answer or 'is not consistent with' in answer or 'is not the same as ' in answer or 'does not correspond to the frequent usage' in answer or 'may not align with' in answer or 'appears to be different' in answer or 'has a different context' in answer or 'does not align with' in answer or 'the context is different' in answer or 'is different' in answer or 'does not fall into the same contexts' in answer or 'appears to have a different meaning' in answer or 'suggests a different context' in answer or 'is figurative and different from' in answer or ' does not have the same meaning as its frequent usage' in answer or 'is not in the same sense' in answer or 'can be interpreted differently from' in answer or '''the usage of "repair" in this sentence differs in its metaphorical sense''' in answer or 'may have a slightly different' in answer or 'is slightly different' in answer or 'differs slightly from' in answer or 'is a different context' in answer or 'Unlike the previous examples' in answer or 'seems to have a different context' in answer or 'deviates from the more typical or frequent usage' in answer or 'it may not be as common as the examples' in answer or 'may not be as common as the more typical or literal usages' in answer or 'in a less literal sense compared to the other examples provided' in answer or 'deviates from the more typical or frequent usage' in answer or 'rather than in its more typical or frequent usage' in answer or 'is used in a more violent or aggressive context' in answer or 'rather than its more typical or frequent' in answer or 'is not the typical or frequent physical' in answer or ' may differ slightly from' in answer or 'may be slightly different from' in answer or 'may indeed differ from' in answer or 'it is not the typical or frequent usage' in answer or 'is less common than the literal usage' in answer or 'may be considered less typical' in answer or 'is used in a somewhat different context' in answer or 'does suggest a different usage' in answer or 'deviates from the more typical' in answer or 'may indicate a different context ' in answer or 'it may not be as commonly expressed' in answer or 'does seem different from' in answer or 'has a slightly different context' in answer or 'rather than its more typical or literal usage' in answer or 'is indeed slightly different from' in answer or 'the specific means of protection may differ' in answer or 'carries a slightly different context' in answer or 'deviates slightly from' in answer or 'might not be considered typical or frequent' in answer or 'may not be as common' in answer or 'represents a different usage' in answer or 'could have a different context' in answer or 'carries a different context' in answer or 'rather than physical movement' in answer or 'may have a different meaning' in answer or 'indicates a different meaning' in answer or 'carries a different meaning' in answer or 'differs in context' in answer or 'implies a different context' in answer or ' suggests a different meaning' in answer or 'carries a slightly different meaning' in answer or 'its context and meaning differ from' in answer or 'and different from the examples provided' in answer or 'and different from its contexts' in answer or 'are somewhat different from' in answer or 'may carry a different connotation' in answer or 'does not refer to taste or endearing qualities as described in the previous examples' in answer or 'does not imply a physical or direct assault like in the examples provided' in answer or '''The previous examples focused on the positive aspects of transformation (e.g., a butterfly's beauty, technological advancements, body improvement), while this sentence portrays a negative or undesirable transformation''' in answer or 'could have different contexts' in answer or 'may be slightly different' in answer or 'is notably different from' in answer or 'rather than the racial or darkness-related connotations mentioned in the examples given' in answer or 'can be perceived as different from' in answer or 'does differ slightly from' in answer or 'does not carry the same negative connotation as in the examples' in answer or 'does not have the same physical connotation as in the examples provided' in answer or 'does not imply the same level' in answer or 'has a different connotation' in answer or 'differs slightly' in answer or 'could be considered different from' in answer:
        return 1
    elif 'would imply a different context' in answer or 'is technically different from' in answer or 'is actually different from' in answer or 'in this sentence differ from its literal usage' in answer or 'the context and meaning differ from' in answer or 'can have a different context' in answer or 'is subtly different from its contexts' in answer or 'is used with a different context ' in answer or 'does not have the same meaning or context' in answer or 'rather than a literal documentation or physical apprehension as seen in the previous examples' in answer or 'is not used in the same context' in answer or 'is distinctly different from' in answer or 'differentiates this context from' in answer or 'is indeed used in a different sense' in answer or 'and different from its literal usage in the above examples' in answer or ' and different from its literal contexts in the examples given' in answer or 'not related to its usage in the examples' in answer or 'not directly related to the physical process of evaporation as described in the previous examples' in answer or 'is being used in a different sense compared to the example' in answer or 'not carry the same meaning as it does in the previous examples' in answer or 'reflects a different meaning' in answer or 'does not refer to the physical act of dancing as it does in the examples provided' in answer or 'does not involve the literal action' in answer or 'does not refer to the physical act' in answer or 'does not refer to military, sports, or cybersecurity circumstances like the examples provided' in answer or 'and different from its literal usage' in answer or 'does not refer to a physical transformation' in answer or 'rather than a single event or physical danger' in answer or 'does not necessarily align with' in answer or 'has a different connotation compared to' in answer or 'not refer to a physical act of transportation' in answer or 'and different from its literal contexts' in answer or 'distinguishing it from the examples' in answer or 'the context and usage differ from the examples' in answer or 'does not refer to physical' in answer or 'and different from its usage' in answer or 'not related to the physical process' in answer or 'does not refer to a physical phase chang' in answer or 'not in the same context' in answer or 'does not have the same meaning' in answer or 'does not have the same literal meaning' in answer or 'does not refer to the physical process' in answer or 'conveys a different context' in answer or 'rather than in a literal sense' in answer or 'rather than its literal usage' in answer or 'indicates a different usage' in answer or 'appears different from the examples given' in answer or 'is not referring to the literal act' in answer or 'does align with the first usage' in answer or 'does have a slightly different connotation' in answer or 'and differs in meaning' in answer or 'rather than the literal' in answer or 'not directly related to the physical act' in answer or 'is used differently compared to' in answer or ' has a slightly different meaning' in answer or 'can be slightly different' in answer or ', distinct from the previous examples' in answer or 'is not describing a physical object' in answer or 'is indeed somewhat different from its contexts' in answer or 'rather than having the same connotations as in the examples' in answer or 'rather than its literal meaning' in answer or 'is in line with the second example' in answer or 'is metaphorical and figurative' in answer or 'is used metaphorically to convey a different meaning' in answer or ', similar to how an army or pests would forcefully infiltrate and cause damage in the above examples.' in answer or 'is used in a slightly different sense' in answer or 'is being used differently in this context compared to the examples given' in answer or 'does not refer to a biological or computer-related transmission, as seen in the previous examples' in answer or 'the context and meaning differ' in answer or 'might have a slightly different meaning' in answer or 'does indeed differ from' in answer or 'is used with a different meaning' in answer or 'can be interpreted as different from' in answer or '''doesn't imply the literal act of consuming or eating as in the first and third examples''' in answer or 'The difference in this context' in answer or 'is being used differently from its contexts' in answer or 'Unlike the examples provided,' in answer or 'deviates from its usage' in answer or 'not have the exact same context as' in answer or 'It does not refer to a physical break or damage, as in the examples provided.' in answer or 'refers to a different meaning' in answer or ', distinct from its medical meaning' in answer or 'suggests a different connotation' in answer or 'can have different meanings depending on the context' in answer or 'differs compared to the examples given above' in answer or 'rather than any of the other contexts mentioned above' in answer or 'is synonymous with the first usage' in answer or 'may have a different connotation' in answer or 'does not refer to a physical appearance or surface quality like in the previous examples' in answer or 'Unlike the literal usage of "muddy" in the previous examples' in answer or 'appears to be slightly different from' in answer or 'is a bit different from' in answer or 'rather than the other contexts mentioned' in answer or 'rather than describing a physical appearance or texture like in the previous examples' in answer or 'is being used differently compared to the examples provided' in answer or 'seems to be used in a different sense' in answer or 'can be interpreted differently' in answer or 'can be seen as different from' in answer or 'does not have the same connotation' in answer or 'rather than referring to' in answer or 'is being used differently from' in answer or 'rather than its metaphorical' in answer or 'rather than the metaphorical' in answer or 'rather than indicating' in answer or 'While the previous examples' in answer or 'appears different from its contexts' in answer or 'not referring to the physical appearance of something reflecting light, as in the previous examples' in answer or 'not in the same sense' in answer or 'does not carry the same meaning' in answer or 'rather than using "sweet" in its affectionate or experiential sense' in answer or 'not to any of the contexts mentioned above' in answer or 'It does not refer to literal wind or weather conditions like it does in the examples provided' in answer or 'deviates from' in answer or 'the context of the word "shiny" is figurative' in answer or 'is somewhat different compared to' in answer or 'does not refer to the literal weather' in answer or 'rather than in the contexts described in the previous examples' in answer or 'the specific context and connotation differ' in answer or 'rather than expressing an emotional state as seen in the examples provided' in answer or 'pertains to a different meaning' in answer or 'may differ slightly' in answer or 'is being used in a slightly different' in answer or 'is not referring to the act of consuming a beverage like in the previous examples' in answer or 'is not being used as a verb to describe the movement of water, ideas, or traffic as in the previous examples' in answer or 'and different from its physical contexts in the previous examples' in answer or 'rather than describing a physical transformation from solid to liquid as in the previous examples' in answer or 'takes a different context' in answer or 'not in its literal sense as it was used in the previous examples' in answer or 'does not refer to the literal pouring' in answer or 'is metaphorical' in answer or 'is used in a metaphorical or figurative sense' in answer or 'the context and usage differ from the previous examples' in answer or 'is used in a metaphorical sense' in answer or 'is used metaphorically' in answer or 'may not align precisely with the examples given' in answer or '''It doesn't involve the physical act of pouring a liquid or pouring out emotions, as seen in the previous examples.''' in answer or 'is figurative' in answer or 'are slightly different from the examples provided' in answer or 'is being used metaphorically' in answer or 'is being used in a metaphorical sense' in answer or 'to convey different meanings from the examples provided' in answer or 'does have a slightly different meaning' in answer or 'the context differs' in answer or 'the specific usage and meaning differ from' in answer or 'is not used in the same sense' in answer or 'may differ from' in answer or 'differs in meaning from' in answer or 'it differs' in answer or 'The word "stick" retains its general connotation of remaining committed or being affected, but the specific context of facing adversity or harm distinguishes it from the previous examples' in answer or 'carries a metaphorical meaning' in answer or 'the context and the object of examination differ from the examples provided' in answer or 'is indeed used with a different meaning' in answer or 'is somewhat different' in answer or 'seems to have a different meaning' in answer or 'is used in a different manner' in answer or 'does have a different meaning' in answer or 'with a different context' in answer or 'has a slightly different connotation' in answer or 'carries a different connotation' in answer or 'is being used with a different meaning than in the previous examples' in answer or 'does not refer to a physical action of travel or transportation like in the previous examples' in answer or 'implies a different meaning' in answer or 'does not appear to be in a military, sports, or cybersecurity context like the examples provided' in answer or 'is used differently' in answer or 'rather than the medical, academic, or forensic contexts mentioned earlier' in answer or 'is not related to taste, endearment, or affection as mentioned in the previous examples' in answer or 'does not refer to taste, affection, or pleasant qualities as mentioned in the previous examples' in answer or 'is not synonymous with the other contexts mentioned above' in answer or ' might be slightly different from' in answer or 'is not being used in the same way' in answer or 'does not have the same racial or symbolic connotations' in answer or "doesn't have the same meaning " in answer or 'can be interpreted as having a different connotation' in answer or ' does not carry the colloquial or expletive connotations' in answer or 'differ from the examples provided above' in answer or 'rather than an emotional state or feeling as in the previous examples' in answer or 'does not have the connotations of intensifying, profanity, or emphasizing negativity like in the examples provided' in answer or 'does not refer to temperature, popularity, or spiciness as in the examples provided' in answer or 'does not carry the same connotation' in answer or 'might be slightly different' in answer or 'is used in different contexts' in answer or 'is not describing taste, endearment, or expressing approval, excitement, or satisfaction as in the examples given' in answer or 'may be different' in answer or 'rather than any other possible meanings of the word "trenched" in other sentences' in answer or 'indicates a different action' in answer or 'seems to differ from' in answer or 'the word "dumb" differ from the examples provided' in answer or 'can have a different meaning' in answer or 'is not using the word "heaped" in the same context' in answer or 'is not similar in context to the previous examples' in answer or 'makes its usage different from' in answer or 'does imply a different context' in answer or 'is quite different from its contexts' in answer or 'is divergent from its contexts' in answer or 'is likely different' in answer or ' may suggest a slightly different' in answer or 'unlike the examples provided' in answer or 'can have different meanings' in answer or 'is being used in a different sense' in answer or 'does not refer to any of the three mentioned usages' in answer or 'many times suggest a different context' in answer or 'rather than a literal sense as in the previous examples' in answer or 'does not fit with any of its common contexts' in answer or 'is significantly different from the examples provided' in answer or ' is generally different from' in answer or 'differs somewhat from' in answer: 
        return 1
    elif 'No,' in answer or 'are the same' in answer or 'is the same as' in answer or 'is not different from' in answer or 'aligns with' in answer or 'are closely related' in answer or 'are related but not necessarily different' in answer or 'not necessarily different from' in answer or 'is likely the same as' in answer or 'would be the same' in answer or 'is not necessarily different from' in answer or 'is closely related to' in answer or 'are related' in answer or 'closely related' in answer or 'appear to be the same' in answer or 'are likely the same' in answer or 'appears to align with' in answer or 'is similar to' in answer or 'the target domain align' in answer or 'matches the target domain' in answer or 'is not fundamentally different from' in answer or 'are aligned' in answer or 'does not differ from' in answer or 'are indeed the same' in answer or 'is not significantly different from ' in answer or 'are actually the same' in answer or 'are essentially the same' in answer or 'are not inherently different' in answer or 'seems to align with' in answer or 'seem to be the same' in answer or 'are not necessarily distinct' in answer or 'appears to be the same as' in answer or 'are not necessarily different' in answer or 'the source domain and the target domain refer to the same' in answer or 'appear to be aligned' in answer or 'appears to align closely with' in answer or 'are not distinct' in answer  or 'seem to pertain' in answer or 'Both domains pertain to' in answer or 'there is no clear distinction or difference between the source domain and the target domain' in answer or 'This is not different' in answer or 'the source and target domains align' in answer or 'are not explicitly different' in answer or 'are one and the same as' in answer or '''there isn't a distinct''' in answer or 'is no clear distinction between' in answer or 'it describes is not necessarily different' in answer or 'is no apparent differentiation between' in answer or 'is not distinct from' in answer or 'is a subset or specific instance within the broader source domain' in answer or 'the source domain and target domain align' in answer or 'is consistent with' in answer or 'appears to be consistent with' in answer or 'in a similar context' in answer or 'does not appear to have a different context' in answer or 'does not seem different from' in answer or 'does not suggest a different context' in answer or 'does not appear to have a different context' in answer or 'deviates from its frequent usage' in answer or 'does not differ significantly from' in answer or 'fits within the familiar usage' in answer or 'is in line with the frequent usage' in answer or 'does not appear to differ' in answer or 'does differ in context' in answer or 'does not represent a significantly different context' in answer or 'does not indicate a different context' in answer or 'would represent a similar usage' in answer or 'does not seem to differ significantly' in answer or 'does not deviate from' in answer or 'does not appear to be significantly different' in answer or 'does not appear to deviate from' in answer or 'seems consistent with' in answer or 'does not significantly differ from' in answer or 'remains consistent with' in answer or 'does not appear to have a significantly different' in answer or 'seems to be consistent with its frequent usage' in answer or 'is within the same range as its frequent usage' in answer or 'does not differ significantly in context' in answer or 'fits within the frequent usage' in answer or 'falls within the frequent usage' in answer or 'is not used in its frequent' in answer or 'does not have a different context' in answer or 'does not significantly alter the context' in answer or 'follows the same context' in answer or 'uses the verb "tensed" in its frequent usage' in answer or 'does not appear to have a context that is significantly different from' in answer or 'within the context of the frequent usage' in answer or 'is used in the same context' in answer or 'uses the verb "capture" in a similar way to the frequent usage' in answer or 'is not different' in answer or 'seems to be consistent with the frequent usage' in answer or 'in a context consistent with its frequent usage' in answer or 'does not differ in context from the frequent usage' in answer or 'is in line with its frequent meaning' in answer or 'appears to be similar to its frequent usage' in answer or 'in a similar manner to its frequent usage' in answer or 'matches its frequent usage' in answer or 'in a context similar to its frequent usage' in answer or 'is used in its typical sense' in answer or 'ses "tensed" in the common usage of the word' in answer or 'appears to have a different context' in answer or 'remains within the frequent usage' in answer or 'is likely to have a similar context to' in answer or 'is indeed similar to its frequent usage' in answer or 'is likely similar to its frequent usage' in answer or ', similar to the frequent usage' in answer or 'suggests a similar context' in answer or 'is similar' in answer or 'is indeed consistent with' in answer or 'can be inferred to be similar' in answer or 'appears to be in line with the frequent usage' in answer or 'can be assumed to have the same meaning' in answer or 'would have the same context' in answer or 'suggests a similar usage' in answer or 'appears similar to its frequent usage' in answer or 'appears to have a similar meaning' in answer or 'appears to be similar to its contexts' in answer or 'remains consistent' in answer or 'seems to be using "melting" in a metaphorical' in answer or 'is not substantially different from' in answer or 'appears to be similar to' in answer or 'appears to fit within the context ' in answer or 'is not notably different from' in answer or 'falls within the same context' in answer or 'follows a similar context to' in answer or 'seems to be similar to ' in answer or 'fits within the same context' in answer or 'is essentially the same as' in answer or 'is still similar to' in answer or 'is generally consistent with' in answer or 'falls within the same general usage' in answer or 'is generally similar to' in answer or 'would still fall within the general usage' in answer or 'remains the same as its frequent usage' in answer or 'does not have a significantly different' in answer or 'remains similar to' in answer or 'could be similar to' in answer or 'suggests a similar meaning' in answer or 'is not explicitly different from' in answer or 'is not noticeably different from' in answer or 'remains the same as' in answer or 'is still consistent with' in answer or 'falls within its typical or frequent usage' in answer or 'is used in its more typical and frequent sense' in answer or 'would be consistent with' in answer or 'is generally the same as' in answer or 'is used in a similar sense' in answer or 'remains within the typical usage' in answer or 'are similar to' in answer or 'are consistent with' in answer or 'is generally the same as' in answer or 'seems similar to' in answer or 'would generally be similar to' in answer or 'retains a similar context' in answer or 'is used in a similar manner' in answer or 'indicates a similar meaning' in answer or 'has a similar context' in answer or 'is actually similar to' in answer or 'aligning with' in answer or 'similar to the third example' in answer or 'the context of the word "swims" in both sentences is the same' in answer or 'appears to have a similar context' in answer or 'would likely be similar to' in answer or 'seems to be consistent with' in answer or 'similar to the second example' in answer or 'is likely similar to' in answer or 'falls under the first example' in answer or 'would be similar to' in answer or 'falls within the first example provided' in answer or 'implies a similar metaphorical usage' in answer or 'conveys the same meaning' in answer or 'falls under the same usage' in answer or 'is essentially similar to its contexts' in answer or 'shares a similar meaning' in answer or 'is quite similar to' in answer or 'can be seen as similar to' in answer or 'is a specialized usage of the term typically found in the context' in answer or 'is conceptually similar to its usage' in answer or 'refers to a similar meaning' in answer or 'is the same usage ' in answer or 'is primarily related to its usage in the first example' in answer or 'would fall under the first example' in answer or 'indicating a similar meaning' in answer or 'pertains to the first example mentioned above' in answer:
        return 0
    elif 'appears to be the same' in answer or 'aligns more closely with the metaphorical sense mentioned in the third example' in answer or 'and similar to the third usage' in answer or 'has a similar meaning to its usage' in answer or 'is used similarly to its contexts' in answer or 'shares similarities with' in answer or 'relates to the metaphorical sense mentioned in example' in answer or 'similar to its usage in the third example' in answer or 'can be similar to the examples' in answer or 'carries a similar meaning to its contexts' in answer or 'falls under the first usage mentioned above' in answer or 'fits within the third usage' in answer or 'is actually quite similar to its usage' in answer or 'and similar to its usage' in answer or 'similar to its second usage' in answer or 'is not used with a different context' in answer or 'falls under the metaphorical usage mentioned in the second example' in answer or 'similar to the first example' in answer or 'is somewhat similar to its usage' in answer or 'appears to be somewhat similar to its usage' in answer or ', similar to its usage' in answer or 'shares similarity with' in answer or 'matches its context' in answer or 'would align with the first example' in answer or 'corresponds to the first context mentioned' in answer or 'falls within the same usage' in answer or 'is the second usage mentioned' in answer or 'is in line with the second usage' in answer or 'is in line with the first example' in answer or ', similar to its context' in answer or 'aligns closely with example' in answer or 'maintains a similar meaning' in answer or 'falls into the second category' in answer or 'remains the same' in answer or 'seems to have a similar context' in answer or 'is equivalent to its contexts' in answer or 'falls under the third category' in answer or 'could potentially refer to the second example' in answer or 'does not appear to be inherently different from' in answer or 'can be considered similar to' in answer or 'is not essentially different from its contexts' in answer or 'is largely similar to' in answer or 'falls under the same category' in answer or 'is somewhat similar to its figurative usage mentioned in point 3' in answer or ', similar to the first usage mentioned above' in answer or 'is fundamentally the same as its contexts' in answer or 'is actually the same as' in answer or 'is metaphorical, similar to example 3 above' in answer or 'is not significantly different' in answer or 'is most likely related to the second usage mentioned above' in answer or 'is synonymous with its usage in the first example' in answer or ', similar to its first usage example' in answer or 'corresponds to the second example provided above' in answer or 'falls under the third example mentioned previously' in answer or 'has the same meaning as the first example mentioned above' in answer or 'is very similar to its contexts' in answer or 'is used in its first example context' in answer or 'is used in a context similar to its first usage' in answer or 'It is used to describe unclear, confused, or muddled thinking about sex, rather than referring to actual physical mud as in the previous examples' in answer or 'corresponds to the first usage mentioned in the examples above' in answer or 'is related to the second example given above' in answer or 'shares a similar context as' in answer or 'the context remains relatively the same' in answer or 'shares a similar context' in answer or 'does not appear to be fundamentally different from' in answer or 'corresponds to the second example mentioned earlier' in answer or ', similar to example 2' in answer or 'can be similar to its usage in the examples' in answer or 'remains within the second common usage' in answer or 'maintains a similar context' in answer or 'be interpreted in a similar way' in answer or 'corresponds to the second example given above' in answer or 'is the same context as in the first example' in answer or 'remain consistent with its usage' in answer or 'corresponds to the third example provided' in answer or 'falls under the third usage' in answer or 'falls under the second usage' in answer or 'aligns closely with its usage' in answer or 'carries a similar meaning' in answer or 'corresponds to its usage in the examples provided' in answer or 'implies a similar meaning' in answer or 'is being used in the same context' in answer or 'is in line with its contexts' in answer or ', similar to its third usage' in answer or 'is aligned with the second example' in answer or ', similar to the second usage' in answer or 'retains a similar meaning' in answer or 'aligns more closely with the third usage' in answer or 'is synonymous with the first example' in answer or 'is related to the third usage' in answer or 'it may share some similarities with the contexts mentioned in the previous examples' in answer or 'falls under the second example' in answer or 'appears to be used in the second sense mentioned' in answer or 'falls under the third example' in answer or 'can be understood as similar to' in answer or 'is used in the second context' in answer or 'it may share some similarities' in answer or ' appears to be synonymous with' in answer or 'in a manner similar to the metaphorical examples' in answer or 'uses the same context as the previous examples' in answer or 'is aligned with its usage' in answer or 'is somewhat similar to its contexts' in answer or 'is aligned with' in answer or 'is more aligned with' in answer or 'does not convey the same meaning' in answer or 'does not refer to temperature, feelings, or food/beverages as in the examples provided' in answer or 'shares a similar connotation' in answer or 'is not completely different from' in answer or ' shares a similarity with' in answer or 'is still related to its usage in the examples' in answer or 'is used in its first context' in answer or 'appears to be more aligned with' in answer or 'is relatively consistent with its contexts' in answer or 'remains within the third usage' in answer or 'appears to match the second usage' in answer or 'does not correspond to the previous examples' in answer or 'is related to its figurative sense mentioned in example 2 above' in answer or 'aligns closely with the first example provided' in answer or 'shares the same meaning as its usage' in answer or 'refers to the first usage mentioned above' in answer or 'is used similarly to the examples given' in answer or 'is primarily aligned with' in answer or 'falls under the first usage' in answer or 'is in line with its second usage' in answer or 'overlaps with the second example given above' in answer or 'does not appear to be substantially different ' in answer or 'corresponds to the third usage' in answer or 'aligns more closely with' in answer or 'The context is the same in this sentence' in answer or 'corresponds to the first usage' in answer or 'falls under the same literal sense' in answer or 'conveys a similar meaning to its contexts' in answer or 'Unlike the literal usage' in answer or 'is used in the first context mentioned' in answer or 'is in line with the figurative sense mentioned in example 3' in answer or 'is used in the same sense as the second example provided earlier' in answer or 'does not seem to be significantly different from' in answer or 'it shares some similarities with the figurative usage in example 2 ' in answer or 'is used similarly to the examples provided' in answer or 'is used with the same general meaning as in the examples provided' in answer or 'Similar to the third example provided' in answer or 'Similar to the metaphorical use described in example 3' in answer or 'is used in a broader context compared to the examples provided' in answer or 'is primarily the same as' in answer or 'is being used in a similar way' in answer or 'does not have a different meaning from' in answer or 'not necessarily differ significantly' in answer or 'is the same context' in answer or 'is used similarly to' in answer or 'is in line with' in answer or 'shares a metaphorical usage similar to example 3' in answer or 'similar to the third usage mentioned' in answer or 'falls within the first usage' in answer or 'falls within the first example' in answer or 'has a similar meaning' in answer or 'is physically similar to the examples given' in answer or 'does not indicate a different meaning' in answer or 'is related to its usage' in answer or 'does not appear to have a different meaning' in answer or 'remains within the same usage' in answer or 'falls under the second category' in answer or 'in a similar way to example' in answer or 'is primarily in line with' in answer or 'appears to fall within' in answer or 'appears to fall within' in answer or 'is used in the same sense' in answer or 'corresponds to the second usage mentioned above' in answer or 'is being used similarly to' in answer or 'aligns closely with' in answer or 'matches the first example' in answer or 'falls under the same context' in answer or 'falls under the same context' in answer or 'is somewhat similar to' in answer or 'corresponds to the second example' in answer or 'corresponds to the first example ' in answer or 'is related to the first example given' in answer or 'is used consistently with its contexts' in answer or 'is still used to evoke a sense of smoothness and elegance' in answer or 'is more closely aligned with' in answer or 'is being used in a similar sense' in answer or 'appears consistent with its contexts' in answer or 'carries a similar context' in answer or 'is related to the third example provided above' in answer or 'is being used in a similar manner' in answer or 'as mentioned in the first example' in answer or 'is related to its frequent usage described in the first example' in answer or 'falls within the second example given' in answer or 'is still related to the concept of calmness as seen in the previous examples' in answer or 'can be similar to its contexts' in answer or 'matches its usage in the first example' in answer or 'is related to its first usage example given above' in answer or 'is related to its first usage' in answer or 'is related to the first example' in answer or 'relates to the second usage' in answer or 'falls within the same frequent usage' in answer or 'shares some similarity with the previous examples' in answer or ', similar to the first usage' in answer or 'refers to the same usage' in answer or 'can imply a similar meaning' in answer or 'is primarily related to the first example' in answer or 'is largely the same as its contexts ' in answer or 'is related to the second example provided' in answer or 'may be similar to its contexts' in answer or 'is relatively similar to its contexts' in answer or 'rather than the colloquial uses described in the previous examples' in answer or 'does not have a different meaning' in answer or 'appears to remain consistent with the previous examples' in answer or 'follows a similar usage pattern' in answer or 'would align with' in answer or 'could potentially have a similar context' in answer or 'remains within the realm of' in answer or 'is used in the first sense' in answer or 'matches the second usage mentioned' in answer or 'conveys a similar meaning' in answer or 'remains similar' in answer or 'does not appear to have a fundamentally different' in answer or 'maintains the same context' in answer or 'retains the same context ' in answer or ', similar to the contexts' in answer or 'refers to the same meaning' in answer or 'falls within the same general meaning' in answer or 'appears to be using the verb "mounted" in the same context as the examples provided' in answer or 'suggests the first usage mentioned' in answer or 'falls under the same culinary sense' in answer or 'can be interpreted as similar to the examples provided' in answer or 'can be interpreted in the same context' in answer or 'it could be interpreted in a similar manner' in answer or 'retains the same meaning' in answer or 'seems to be used in the same way' in answer or 'is primarily similar to the second usage' in answer or 'falls within the general usage' in answer or 'can be interpreted similarly' in answer or 'carries the same meaning' in answer or 'matches the third context mentioned above' in answer or 'falls under the first category mentioned above' in answer or 'follows the first example provided above' in answer or 'is more related to the first example' in answer or 'appears similar to its usage' in answer or 'does not appear significantly different from' in answer or 'is used in a similar artistic sense as in the examples' in answer or 'does not indicate a significantly different' in answer or 'maintains the same meaning' in answer or 'is most likely similar to' in answer or 'remains largely the same as in the examples' in answer or 'may have a similar context to the previous examples' in answer or 'is used in a literal sense in the previous sentences' in answer or 'has the same context as the examples provided' in answer or 'is likely used in a similar sense' in answer or ', similar to the aforementioned examples' in answer or 'follows a similar context' in answer or 'would likely fall under the first example' in answer or 'can be inferred to have a similar meaning' in answer or 'refers to the weather forecast usage described in the first example' in answer or 'is synonymous with its usage' in answer or '''the word "dumb" is used in the first example's context''' in answer or 'corresponds to its usage in the first example' in answer or 'appears consistent with the first usage' in answer or 'falls under the second context mentioned above' in answer or 'can be similar to' in answer or 'suggests a similar sense' in answer or 'could be similar in context' in answer or 'appears similar to' in answer or 'is relatively similar to' in answer or ', similar to the examples given' in answer or 'seems to be the same as its usage' in answer or 'uses the verb "heaped" similarly ' in answer or 'is related to the legal sense mentioned in example 2' in answer or 'seems to be the same as' in answer or 'is consistent in ' in answer or 'suggesting a similar context' in answer: 
        return 0

    elif "it's difficult to provide a definitive answer" in answer or 'without further context or information' in answer or 'without more context' in answer or 'provide more context' in answer or 'without additional context' in answer.lower() or 'it is not possible to determine' in answer or 'without further context' in answer.lower():
        return -1
    else:
        print(answer + '\n=================')
        return -1

def exist_refuse_to_answer(answers):
    refuse_to_answer_list = ['depends on the context', 'it is not possible to determine', 'without additional context', 'vary depending on the context', 'would depend on the specific context', 'without further context', 'additional context or information', 'additional context', 'it is difficult to determine', 'additional information', 'depends on the specific context', 'cannot be determined']
    final_answer = ''
    for answer in answers:
        flag_refuse_to_answer = False
        for refuse_to_answer_phrase in refuse_to_answer_list:
            if refuse_to_answer_phrase in answer.lower():
                flag_refuse_to_answer = True
                break
        if flag_refuse_to_answer == False:
            final_answer = answer
            break
    return final_answer

dataset_to_fileList = {
    'MOH-X':['MOH-X.csv'],
    'TroFi':['TroFi.csv'],
}

knowledge_list = [
    '''The phrase "frequent usage of a word" refers to the regular and common application of a word.
''',
'''In the theory of selectional preference violation, Wilks suggests that metaphor represents a violation of combinatory norms in the linguistic context and that metaphorical expressions can be detected via such violation.
''',
]
pos_to_word = {
    'verb':'verb',
}
system_prompt = '''You are ChatGPT, a large language model trained by OpenAI. Answer as concisely as possible.
Knowledge cutoff: 2021-09
Current date: 2023-10-15'''


second_question_prompt = '''In the sentence "[sentence]", decide whether the context of the word "[target_word]" is different from its contexts in the above sentences.'''

first_prompt_context = '''Now we know examples of the frequent usage of the [pos] "[target_word]".\n\n'''



def parse_option():
    parser = argparse.ArgumentParser(description='')
    parser.add_argument('--data_dir', default='results/SPV-2que-1.0-vrto0.8-sim1.5-5-3/gpt-3.5-turbo-0613/', type=str)
    parser.add_argument('--baseline', default='SPV-2que-add-kdg', type=str, help='')
    parser.add_argument('--vote_number', default=5, type=int)
    parser.add_argument('--dataset', default='MOH-X', type=str, help='dataset name, MOH-X, TroFi')
    parser.add_argument('--output_path', default='results/', type=str)
    parser.add_argument('--vote_ratio', default=0.8, type=float) # 1 时相当于 所有的词义对都需要满足相似
    parser.add_argument('--sentence_similar_ratio', default=1.5, type=float)
    parser.add_argument('--temp', default=1.0, type=float)
    parser.add_argument('--add_kdg_number', default=3, type=int)
    parser.add_argument('--_model', default='gpt-3.5-turbo-0613', type=str, help='''gpt-3.5-turbo-0613''')
    args, unparsed = parser.parse_known_args()
    return args



def main(args):

    _model = args.data_dir.split('/')[-2]
    args._model = _model
    args.baseline = args.baseline + '-' + str(args.temp) +  '-vrto' + str(args.vote_ratio)+ '-sim' + str(args.sentence_similar_ratio) + '-' + str(args.vote_number) + '-' + str(args.add_kdg_number)
    dataloader = Data_Processor(args)
    vote_baseline_number = round(args.vote_number * args.vote_ratio)
    for file in dataset_to_fileList[args.dataset]:
        new_samples = []
        samples = dataloader.get_dataset(file)
        new_samples = dataloader.get_dataset_output(file)
        for sample_id in range(len(new_samples), len(samples)):
            sample  = samples[sample_id]
            sample  = samples[sample_id]
            sentence,label,target_position,target_word,pos_tag,gloss,eg_sent,prompt,answer_text,answer_add_text, soure_domain_list_text, soure_domain_score_text, first_final_answer = sample
            sentence_add_punch = sentence.replace(' ,', ',').replace(' .', '.').replace(' !', '!').replace(' ?', '?').replace(' "', '"').replace('  .', '.')
            answers = eval(answer_text)
            answer_adds = eval(answer_add_text)
            first_answers = answers[0]
            first_answer = ''
            if first_final_answer == '':
                first_answer = random.sample(first_answers, 1)
            else:
                first_answer = first_final_answer
            second_answers = answers[1]

            different_count = 0
            non_different_count = 0
            second_final_answer = ''

            for second_answer in second_answers:
                second_answer_index = return_relation_exist(second_answer)
                if second_answer_index == 1:
                    different_count += 1
                elif second_answer_index == 0:
                    non_different_count += 1
            if different_count >= vote_baseline_number:
                second_final_answer == 'exist'
            elif non_different_count >= vote_baseline_number:
                second_final_answer = 'non-exist'
            else:
                # need knowledge
                prompt_contrast = second_question_prompt.replace('[target_word]', target_word).replace('[sentence]', sentence_add_punch)
                prompt_second_add_knowledge = knowledge_list[1] + '\n' + 'Taking the knowledge provided above into account, please answer the following question:\n' + first_prompt_context.replace('[sentence]', sentence_add_punch).replace('[target_word]', target_word).replace('[pos]', pos_to_word[pos_tag.lower()]) + first_answer + '\n\n'  + prompt_contrast
                if args._model in ['gpt-3.5-turbo-0613']:
                    dialogs = [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": prompt_second_add_knowledge}
                        ]
                    response = openai.ChatCompletion.create(
                    model=_model,
                    messages=dialogs,
                        # max_tokens=10,
                        n=args.add_kdg_number,
                        temperature=args.temp,
                    )
                    answers_res = []
                    for answer_add_i in range(args.add_kdg_number):
                        answers_res.append(response['choices'][answer_add_i]['message']['content'])
                    answer_adds.append(answers_res) 
                    

                    final_second_answer_text = exist_refuse_to_answer(answers_res)

                    if final_second_answer_text != '':
                        second_answer_index = return_relation_exist(final_second_answer_text)
                        if second_answer_index == 1:
                            second_final_answer = 'exist'
                        elif second_answer_index == 0:
                            second_final_answer = 'non-exist'
                        else:
                            second_final_answer = ''

                else:
                    print('no such model')
            new_samples.append(sample[:7]+ [str(dialogs)] + [str(answers)] + [str(answer_adds)] + sample[10:] + [second_final_answer])
            head = ['sentence','label','target_position','target_word','pos_tag','gloss','eg_sent','question', 'answer', 'answer_add', 'soure_domain_list', 'soure_domain_list_score', 'first_answer_final','second_answer_final']
            dataloader.write_dataset(file, head, new_samples)


if __name__ == '__main__':
    args = parse_option()

    main(args)